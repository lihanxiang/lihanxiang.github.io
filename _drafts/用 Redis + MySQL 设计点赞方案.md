---
layout: post
title: 用 Redis + MySQL 设计点赞方案
categories: [设计方案]
description: 用 Redis 做缓存 +MySQL 持久化来设计作品点赞方案
keywords: Java, Redis, MySQL, 方案设计，缓存设计
mermaid: false
sequence: false
flow: false
mathjax: false
mindmap: false
mindmap2: false
---

最近在工作中遇到了一个作品点赞功能的业务需求，就想着记录一下设计过程中的想法以及最终实现的结果



### 为什么不直接用 MySQL

点赞接口的访问量较大，写压力较大，直接用 MySQL 太粗暴了，并且在数据量大的时候会影响用户体验，而且大部分用户对于总赞数的即时性要求不高，只要知道自己点赞过就行了，所以不用每次一点赞就查询总赞数并展示





### 方案讨论

目前几大网站上对于点赞的方案设计大概分两种：



#### 点赞时前端直接操作总赞数 +1，不管总赞数的准确性（Redis 缓存 + MySQL落地）

用户在点击点赞按钮时，前端直接将数据 + 1 并展示，不用等后端接口返回数据，只有在进入该页面时，才获取数据库中记录的总赞数并展示

举个例子，如果 10 个人同时在点赞数为 100 的时候进入页面，并点赞（前端发起 10 次点赞请求，后端缓存或数据库新增 10 条数据，反正就是这 10 次点赞被记录了），这时候 10 人看见的点赞数都是 101，在退出当前页并重新进入时，前端会发起请求并等待数据返回，这时候用户看见的就是最准确的点赞数 110，参考 B 站或一些视频网站的做法，用户对点赞数量的准确性并不关心，只知道自己点赞成功了就行

但是这种做法会有概率导致数据丢失，在缓存还未同步到数据库时，断电或设备故障会导致缓存的数据丢失，B 站有时候就会丢失点赞记录，我一键三连的视频过段时间再打开就会发现只有投币和收藏（瞎猜是点赞缓存，投币和收藏直接记录至数据库）



#### 点赞时前端不直接操作总赞数，等待后端返回数据并刷新（直接 MySQL 落地）

用户在点击点赞按钮时，前端发起请求，后端处理请求（更新点赞 +1，并查询总赞数返回给前端），用户在点赞后就能看见最准确的总赞数

还是那个例子，如果 10 个人同时在点赞数为 100 的时候进入页面，并点赞，这时候根据数据更新的顺序，第一个完成点赞请求的人看见的总赞数就是 101，第二个完成点赞请求的人看见的总赞数就是 102，这顺序并不一定按照发起请求的顺序来，而是按照数据库更新数据的时间

参考知乎和一些文字类网站的做法，你在点赞某个回答时候，会看到大概一秒钟的停顿（前端发起请求，正在等待后端返回结果），然后就会展示总赞数

比如你在早上 9 点打开知乎浏览某个回答，这时候的点赞数量是 1000，然后你突然手头上来活了，等你忙完到了 11 点才开始看刚才打开的回答，看完之后点了个赞，这时候会发现这个回答的点赞数量已经到了 1500，就说明在你打开这个回答到你点赞之间的时间内，有 499 个人给这个回答点赞了，所以在你点赞之后能够看到最精确的总赞数



只有第一种方案会用到缓存机制，因为第二种方案中每次点赞都要获取最新数据，即使用缓存也是直接击穿，多此一举，不过不管使用哪种方式，在重新进入页面获取详情数据时候，都要获取到最准确的总赞数



### 确定 v1.0 方案

因为





